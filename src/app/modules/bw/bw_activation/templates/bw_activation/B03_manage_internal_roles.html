{% extends "layout.html" %}

{% block title %}Gérer les Rôles Internes{% endblock %}

{% block content %}
    <div
        class="max-w-6xl mx-auto"
        x-data="{ selfBWMi: false, selfBWPRi: false }"
    >
        <div class="bg-white p-8 rounded-2xl shadow-lg border border-gray-200">
            <h1 class="text-3xl font-bold text-gray-900">
                3- Gérer les Rôles Internes
            </h1>
            <p class="mt-2 text-gray-600">
                Nommez des Business Wall Managers et des
                {{ bw_info.manager_role }}s au sein de votre équipe.
            </p>

            <div class="mt-4 p-4 bg-blue-50 rounded-md border border-blue-200">
                <p class="text-sm text-gray-700">
                    <strong>Type de Business Wall :</strong> {{ bw_info.name }}
                </p>
            </div>

            {% if bw_info.allows_self_management | default(false) %}
                <!-- Self-assignment options for small organizations -->
                <div
                    class="mt-8 p-6 bg-amber-50 rounded-lg border border-amber-200"
                >
                    <h3 class="font-semibold text-amber-900 mb-3">
                        Option rapide pour les structures individuelles
                    </h3>
                    <p class="text-sm text-amber-800 mb-4">
                        Si vous êtes une structure individuelle ou si vous
                        souhaitez gérer vous-même votre Business Wall, vous
                        pouvez vous auto-attribuer les rôles ci-dessous.
                    </p>

                    <div class="space-y-3">
                        <label class="flex items-center gap-3 cursor-pointer">
                            <input
                                type="checkbox"
                                name="self_bwmi"
                                x-model="selfBWMi"
                                class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                            />
                            <span class="text-sm text-gray-700">
                                <strong
                                    >Je suis mon propre BW Manager
                                    interne</strong
                                >
                                - Je gère moi-même l'administration de mon
                                Business Wall
                            </span>
                        </label>

                        <label class="flex items-center gap-3 cursor-pointer">
                            <input
                                type="checkbox"
                                name="self_bwpri"
                                x-model="selfBWPRi"
                                class="h-4 w-4 rounded border-gray-300 text-green-600 focus:ring-green-500"
                            />
                            <span class="text-sm text-gray-700">
                                <strong
                                    >Je suis mon propre
                                    {{ bw_info.manager_role }} interne</strong
                                >
                                - Je gère moi-même les relations presse et la
                                publication de contenu
                            </span>
                        </label>
                    </div>
                </div>
            {% endif %}

            <!-- Section 0: Business Wall Owner -->
            <div class="mt-8">
                <h2
                    class="text-2xl font-semibold text-purple-800 border-b pb-3 mb-6"
                >
                    Business Wall Owner
                </h2>

                <div class="p-4 bg-white rounded-md border border-gray-200">
                    <h3 class="font-medium text-gray-900 mb-4">
                        Propriétaire du Business Wall
                    </h3>
                    {% if owner_info %}
                        <div
                            class="flex items-center gap-4 p-3 bg-purple-50 rounded-md"
                        >
                            <div>
                                <p class="text-sm font-medium text-gray-900">
                                    {{ owner_info.full_name }}
                                </p>
                                <p class="text-sm text-gray-500">
                                    {{ owner_info.email }}
                                </p>
                            </div>
                        </div>
                    {% else %}
                        <div class="text-sm text-gray-500 italic">
                            Aucun propriétaire défini.
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Section 1: Business Wall Managers Internes (BWMi) -->
            <div
                class="mt-8"
                x-show="!selfBWMi"
                x-transition
            >
                <h2
                    class="text-2xl font-semibold text-blue-800 border-b pb-3 mb-6"
                >
                    Business Wall Managers Internes (BWMi)
                </h2>

                <!-- Button to open modal for BWMi invitations -->
                <div class="mb-6">
                    <button
                        type="button"
                        id="list_bwmi_invitations_button"
                        data-modal-target="list_bwmi_invitations_modal"
                        data-modal-toggle="list_bwmi_invitations_modal"
                        class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                    >
                        Liste invitations BWMi
                    </button>
                </div>

                <!-- Current BWMi invitations preview -->
                <div
                    class="p-4 bg-white rounded-md border border-gray-200 mb-6"
                >
                    <h3 class="font-medium text-gray-900 mb-3">
                        Invitations BWMi en cours
                        ({{ bwmi_invitations|length if bwmi_invitations else 0 }})
                    </h3>
                    {% if bwmi_invitations %}
                        <div
                            class="border border-gray-200 rounded-md divide-y divide-gray-200"
                        >
                            {% for email in bwmi_invitations|sort %}
                                <div
                                    class="flex items-center gap-3 px-3 py-2 bg-blue-50"
                                >
                                    <div class="flex-shrink-0">
                                        <div
                                            class="w-7 h-7 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-semibold text-xs"
                                        >
                                            @
                                        </div>
                                    </div>
                                    <div class="min-w-0 flex-1">
                                        <p
                                            class="text-sm font-medium text-gray-900 truncate"
                                        >
                                            {{ email }}
                                        </p>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-sm text-gray-500 italic">
                            Aucune invitation BWMi en cours.
                        </div>
                    {% endif %}
                </div>

                <!-- Current BWMi members -->
                <div class="p-4 bg-white rounded-md border border-gray-200">
                    <h3 class="font-medium text-gray-900 mb-3">
                        Business Wall Managers actuels
                        ({{ bwmi_members|length if bwmi_members else 0 }})
                    </h3>
                    {% if bwmi_members %}
                        <div
                            class="border border-gray-200 rounded-md divide-y divide-gray-200"
                        >
                            {% for member in bwmi_members|sort(attribute='last_name') %}
                                <div
                                    class="flex items-center gap-3 px-3 py-2 bg-gray-50"
                                >
                                    <div class="flex-shrink-0">
                                        <div
                                            class="w-7 h-7 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-semibold text-xs"
                                        >
                                            {{ member.first_name[0] if member.first_name else '?' }}{{ member.last_name[0] if member.last_name else '' }}
                                        </div>
                                    </div>
                                    <div class="min-w-0 flex-1">
                                        <p
                                            class="text-sm font-medium text-gray-900 truncate"
                                        >
                                            {{ member.last_name }}
                                            {{ member.first_name }}
                                        </p>
                                        <p
                                            class="text-xs text-gray-500 truncate"
                                        >
                                            {{ member.email }}
                                        </p>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-sm text-gray-500 italic">
                            Aucun Business Wall Manager nommé pour le moment.
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Modal for editing BWMi invitations -->
            <div
                id="list_bwmi_invitations_modal"
                data-modal-backdrop="static"
                tabindex="-1"
                aria-hidden="true"
                class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full"
            >
                <div class="relative p-4 w-full max-w-screen-sm max-h-full">
                    <div
                        class="relative bg-white rounded-lg shadow dark:bg-gray-700"
                    >
                        <h4
                            class="pl-2 text-lg font-semibold text-gray-900 dark:text-white"
                        >
                            Liste des invitations BWMi
                        </h4>
                        <p
                            class="bg-white rounded-lg shadow dark:bg-gray-700 pl-2 pr-2 pt-1 text-sm text-gray-900 dark:text-white"
                        >
                            Pour modifier la liste des invitations BWMi, ajouter
                            ou retirer un email. Les invitations permettent aux
                            membres de l'organisation de devenir BW Managers.
                            Une notification sera envoyée avec un lien pour
                            accepter ou refuser la nomination.
                        </p>
                        <div class="p-2">
                            <form
                                class="space-y-4"
                                action="#"
                            >
                                <div>
                                    <textarea
                                        name="content"
                                        id="bwmi_content"
                                        class="block p-2 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 placeholder:text-gray-900 focus:outline-none dark:bg-gray-700 dark:border-gray-600 dark:gray-100"
                                        rows="6"
                                    >
{{ bwmi_invitations|sort|join('\n') if bwmi_invitations else '' }}</textarea
                                    >
                                </div>
                                <div
                                    class="mt-12 flex items-center justify-end gap-x-6"
                                >
                                    <button
                                        type="submit"
                                        hx-post="{{ url_for('bw_activation.manage_internal_roles') }}"
                                        hx-vals='{"action": "change_bwmi_invitations"}'
                                        data-modal-hide="list_bwmi_invitations_modal"
                                        class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                                    >
                                        Valider
                                    </button>
                                    <button
                                        data-modal-hide="list_bwmi_invitations_modal"
                                        type="button"
                                        class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-gray-500 hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400"
                                    >
                                        Annuler
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Self-assigned BWMi confirmation -->
            <div
                class="mt-8 p-4 bg-blue-50 rounded-md border border-blue-200"
                x-show="selfBWMi"
                x-transition
            >
                <div class="flex items-center gap-3">
                    <svg
                        class="w-6 h-6 text-blue-600"
                        fill="currentColor"
                        viewBox="0 0 20 20"
                    >
                        <path
                            fill-rule="evenodd"
                            d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                            clip-rule="evenodd"
                        />
                    </svg>
                    <p class="text-sm text-blue-800">
                        <strong
                            >Vous êtes votre propre BW Manager interne.</strong
                        >
                        Vous gérez l'administration de votre Business Wall.
                    </p>
                </div>
            </div>

            <!-- Section 2: Business Wall PR Managers Internes (BWPRi) -->
            <div
                class="mt-8"
                x-show="!selfBWPRi"
                x-transition
            >
                <h2
                    class="text-2xl font-semibold text-green-800 border-b pb-3 mb-6"
                >
                    Business Wall {{ bw_info.manager_role }}s Internes
                    (BWPR{{ bw_info.manager_role[0] }}i)
                </h2>

                <!-- Button to open modal for BWPRi invitations -->
                <div class="mb-6">
                    <button
                        type="button"
                        id="list_bwpri_invitations_button"
                        data-modal-target="list_bwpri_invitations_modal"
                        data-modal-toggle="list_bwpri_invitations_modal"
                        class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500"
                    >
                        Liste invitations BWPRi
                    </button>
                </div>

                <!-- Current BWPRi invitations preview -->
                <div
                    class="p-4 bg-white rounded-md border border-gray-200 mb-6"
                >
                    <h3 class="font-medium text-gray-900 mb-3">
                        Invitations BWPRi en cours
                        ({{ bwpri_invitations|length if bwpri_invitations else 0 }})
                    </h3>
                    {% if bwpri_invitations %}
                        <div
                            class="border border-gray-200 rounded-md divide-y divide-gray-200"
                        >
                            {% for email in bwpri_invitations|sort %}
                                <div
                                    class="flex items-center gap-3 px-3 py-2 bg-green-50"
                                >
                                    <div class="flex-shrink-0">
                                        <div
                                            class="w-7 h-7 rounded-full bg-green-100 flex items-center justify-center text-green-600 font-semibold text-xs"
                                        >
                                            @
                                        </div>
                                    </div>
                                    <div class="min-w-0 flex-1">
                                        <p
                                            class="text-sm font-medium text-gray-900 truncate"
                                        >
                                            {{ email }}
                                        </p>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-sm text-gray-500 italic">
                            Aucune invitation BWPRi en cours.
                        </div>
                    {% endif %}
                </div>

                <!-- Current BWPRi members -->
                <div class="p-4 bg-white rounded-md border border-gray-200">
                    <h3 class="font-medium text-gray-900 mb-3">
                        {{ bw_info.manager_role }}s actuels
                        ({{ bwpri_members|length if bwpri_members else 0 }})
                    </h3>
                    {% if bwpri_members %}
                        <div
                            class="border border-gray-200 rounded-md divide-y divide-gray-200"
                        >
                            {% for member in bwpri_members|sort(attribute='last_name') %}
                                <div
                                    class="flex items-center gap-3 px-3 py-2 bg-gray-50"
                                >
                                    <div class="flex-shrink-0">
                                        <div
                                            class="w-7 h-7 rounded-full bg-green-100 flex items-center justify-center text-green-600 font-semibold text-xs"
                                        >
                                            {{ member.first_name[0] if member.first_name else '?' }}{{ member.last_name[0] if member.last_name else '' }}
                                        </div>
                                    </div>
                                    <div class="min-w-0 flex-1">
                                        <p
                                            class="text-sm font-medium text-gray-900 truncate"
                                        >
                                            {{ member.last_name }}
                                            {{ member.first_name }}
                                        </p>
                                        <p
                                            class="text-xs text-gray-500 truncate"
                                        >
                                            {{ member.email }}
                                        </p>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-sm text-gray-500 italic">
                            Aucun {{ bw_info.manager_role }} nommé pour le
                            moment.
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Modal for editing BWPRi invitations -->
            <div
                id="list_bwpri_invitations_modal"
                data-modal-backdrop="static"
                tabindex="-1"
                aria-hidden="true"
                class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full"
            >
                <div class="relative p-4 w-full max-w-screen-sm max-h-full">
                    <div
                        class="relative bg-white rounded-lg shadow dark:bg-gray-700"
                    >
                        <h4
                            class="pl-2 text-lg font-semibold text-gray-900 dark:text-white"
                        >
                            Liste des invitations BWPRi
                        </h4>
                        <p
                            class="bg-white rounded-lg shadow dark:bg-gray-700 pl-2 pr-2 pt-1 text-sm text-gray-900 dark:text-white"
                        >
                            Pour modifier la liste des invitations BWPRi,
                            ajouter ou retirer un email. Les invitations
                            permettent aux membres de l'organisation de devenir
                            {{ bw_info.manager_role }}s. Une notification sera
                            envoyée avec un lien pour accepter ou refuser la
                            nomination.
                        </p>
                        <div class="p-2">
                            <form
                                class="space-y-4"
                                action="#"
                            >
                                <div>
                                    <textarea
                                        name="content"
                                        id="bwpri_content"
                                        class="block p-2 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 placeholder:text-gray-900 focus:outline-none dark:bg-gray-700 dark:border-gray-600 dark:gray-100"
                                        rows="6"
                                    >
{{ bwpri_invitations|sort|join('\n') if bwpri_invitations else '' }}</textarea
                                    >
                                </div>
                                <div
                                    class="mt-12 flex items-center justify-end gap-x-6"
                                >
                                    <button
                                        type="submit"
                                        hx-post="{{ url_for('bw_activation.manage_internal_roles') }}"
                                        hx-vals='{"action": "change_bwpri_invitations"}'
                                        data-modal-hide="list_bwpri_invitations_modal"
                                        class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500"
                                    >
                                        Valider
                                    </button>
                                    <button
                                        data-modal-hide="list_bwpri_invitations_modal"
                                        type="button"
                                        class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-gray-500 hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400"
                                    >
                                        Annuler
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Self-assigned BWPRi confirmation -->
            <div
                class="mt-8 p-4 bg-green-50 rounded-md border border-green-200"
                x-show="selfBWPRi"
                x-transition
            >
                <div class="flex items-center gap-3">
                    <svg
                        class="w-6 h-6 text-green-600"
                        fill="currentColor"
                        viewBox="0 0 20 20"
                    >
                        <path
                            fill-rule="evenodd"
                            d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                            clip-rule="evenodd"
                        />
                    </svg>
                    <p class="text-sm text-green-800">
                        <strong
                            >Vous êtes votre propre {{ bw_info.manager_role }}
                            interne.</strong
                        >
                        Vous gérez les relations presse et publiez le contenu de
                        votre Business Wall.
                    </p>
                </div>
            </div>

            <!-- Navigation -->
            <div
                class="mt-10 flex items-center justify-between gap-x-6 border-t pt-6"
            >
                <a
                    href="{{ url_for('bw_activation.manage_organisation_members') }}"
                    class="text-sm font-semibold leading-6 text-gray-900 hover:text-gray-700"
                >
                    ← Retour à la liste des membres
                </a>
                <a
                    href="{{ url_for('bw_activation.manage_external_partners') }}"
                    class="rounded-md bg-blue-600 px-5 py-2.5 text-sm font-semibold text-white shadow-sm hover:bg-blue-700"
                >
                    Étape suivante : Partenaires externes →
                </a>
            </div>
        </div>
    </div>
{% endblock %}
