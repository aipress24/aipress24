{% extends "wip/layout/_base.j2" %}

  {% macro render_selector(selector, model) %}
  <div class="aui-field-group mb-4">
      <label for="{{ selector.id }}" class="font-bold block mb-1">
          {{ selector.label }}
      </label>

      <select
          id="{{ selector.id }}"
          name="{{ selector.id }}"
          class="tom-select-it"
          multiple
          placeholder="Choisir..."
      >
          {% for opt in selector.options %}
              <option value="{{ opt.id }}" {{ opt.selected }}>
                  {{ opt.label }}
              </option>
          {% endfor %}
      </select>
  </div>
  {% endmacro %}

{% block body_content %}
  <div id="main">
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>

    <h2 class="aui-title">Cibler les personnes Ã  contacter</h2>

    <form id="search-form" hx-target="#main">
      <div class="grid lg:grid-cols-2 gap-4">
        {% for selector in form.selectors %}
          {{ render_selector(selector, model) }}
        {% endfor %}
      </div>
    </form>

    {% include "wip/avis_enquete/_experts.j2" %}

    <script>
      (function() {
          function setup() {
              if (typeof TomSelect === 'undefined') {
                  setTimeout(setup, 10);
                  return;
              }

              document.querySelectorAll('.tom-select-it').forEach(el => {
                  if (el.tomselect) return;

                  const ts = new TomSelect(el, {
                      maxOptions: null,
                      maxItems: null,
                      allowEmptyOption: true,
                      plugins: ['remove_button'],
                      onChange: function() {
                          let values = htmx.values(htmx.find('#search-form'));
                          values.selector_change = 1;
                          const url = "{{ url_for('AvisEnqueteWipView:ciblage', id=model.id) }}";
                          htmx.ajax('GET', url, {
                              target: '#main',
                              select: '#main',
                              values: values
                          });
                      }
                  });
              });
          }
          setup();
      })();
    </script>
  </div>
{% endblock %}
